<!DOCTYPE html>
<html lang="ur" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نوٹ لکھیں اور سنیں - Urdu Notes & Voice App</title>

    <!-- Meta Tags for SEO and PWA -->
    <meta name="description" content="آسانی سے اردو میں نوٹ لکھیں، بول کر لکھوائیں، اور محفوظ کریں۔ طلباء، بزرگوں، اور بصارت سے محروم صارفین کے لیے بہترین۔">
    <meta name="keywords" content="Urdu notes, voice notes, urdu typing, urdu speech to text, notes app, PWA">
    <meta name="author" content="Gemini">
    <meta name="theme-color" content="#009688">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg transform='translate(10,10)'%3E%3Cpath d='M80.5,23.5 L63,41 L63,13.5 C63,10.7 60.8,8.5 58,8.5 L18,8.5 C15.2,8.5 13,10.7 13,13.5 L13,68.5 C13,71.3 15.2,73.5 18,73.5 L48,73.5' fill='none' stroke='%23009688' stroke-width='5'/%3E%3Cpath d='M50,45 C50,36.7 56.7,30 65,30 C73.3,30 80,36.7 80,45 L80,55 C80,63.3 73.3,70 65,70 C56.7,70 50,63.3 50,55 Z M65,70 L65,85 M55,85 L75,85' fill='none' stroke='%23ff9800' stroke-width='5'/%3E%3C/g%3E%3C/svg%3E">

    <!-- Embedded PWA Manifest to prevent 404 error -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlVyZHUgTm90ZXMgJiBWb2ljZSBBcHAiLAogICJzaG9ydF9uYW1lIjogIlVyZHUgTm90ZXMiLAogICJkZXNjcmlwdGlvbiI6ICJFYXNpbHkgd3JpdGUsIGRpY3RhdGUsIGFuZCBzYXZlIG5vdGVzIGluIFVyZHUuIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZGZhZjYiLAogICJ0aGVtZV9jb2xvciI6ICIjMDA5Njg4IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaWNvbi0xOTIucG5nIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImljb24tNTEyLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQo=">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Jameel Noori Nastaleeq for Urdu, Inter for English -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jameel+Noori+Nastaleeq&display=swap');
    </style>

    <!-- Custom CSS with Animations -->
    <style>
        :root {
            --bg-light: #fdfaf6; --text-light: #333333;
            --bg-dark: #121212; --text-dark: #eeeeee;
            --primary: #009688; --accent: #ff9800;
            --primary-dark: #00796B;
            --text-secondary-light: #555; --text-secondary-dark: #aaa;
            --card-bg-light: rgba(255, 255, 255, 0.5); --card-border-light: rgba(255, 255, 255, 0.7);
            --card-bg-dark: rgba(30, 30, 30, 0.5); --card-border-dark: rgba(255, 255, 255, 0.1);
            --card-bg-hc: #0a0a0a; --card-border-hc: #ffffff;
            --primary-hc: #ffff00; --accent-hc: #00ffff; --primary-dark-hc: #eeee00;
        }
        html.light { --bg-color: var(--bg-light); --text-color: var(--text-light); --text-secondary-color: var(--text-secondary-light); --card-bg: var(--card-bg-light); --card-border: var(--card-border-light); --primary-color: var(--primary); --accent-color: var(--accent); --primary-dark-color: var(--primary-dark); }
        html.dark { --bg-color: var(--bg-dark); --text-color: var(--text-dark); --text-secondary-color: var(--text-secondary-dark); --card-bg: var(--card-bg-dark); --card-border: var(--card-border-dark); --primary-color: var(--primary); --accent-color: var(--accent); --primary-dark-color: var(--primary-dark); }
        html.high-contrast { --bg-color: #000; --text-color: #fff; --text-secondary-color: #ddd; --card-bg: var(--card-bg-hc); --card-border: var(--card-border-hc); --primary-color: var(--primary-hc); --accent-color: var(--accent-hc); --primary-dark-color: var(--primary-dark-hc); }

        body { background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.5s, color 0.5s; }
        .font-urdu { font-family: 'Jameel Noori Nastaleeq', serif; }
        .font-english { font-family: 'Inter', sans-serif; }
        .font-size-small { font-size: 0.875rem; } .font-size-medium { font-size: 1rem; } .font-size-large { font-size: 1.25rem; }
        .text-primary { color: var(--primary-color); } .bg-primary { background-color: var(--primary-color); } .hover\:bg-primary-dark:hover { background-color: var(--primary-dark-color); } .border-primary { border-color: var(--primary-color); }
        .text-accent { color: var(--accent-color); } .bg-accent { background-color: var(--accent-color); }
        .text-text { color: var(--text-color); } .text-text-secondary { color: var(--text-secondary-color); }

        .glassmorphism-card { background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 1rem; border: 1px solid var(--card-border); transition: all 0.5s; }
        .note-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-animated { transition: transform 0.1s ease-out, box-shadow 0.2s; }
        .btn-animated:active { transform: scale(0.95); box-shadow: none; }

        @keyframes splash-pop { to { opacity: 1; transform: scale(1); } }
        @keyframes splash-fade-up { to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark-color); }
    </style>
</head>
<body class="min-h-screen">

    <!-- Splash Screen - Mobile ke liye optimize kiya gaya hai -->
    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center transition-opacity duration-700" style="background-color: var(--bg-color);">
        <div class="flex items-center gap-2 text-3xl md:text-4xl" style="opacity:0; transform: scale(0.8); animation: splash-pop 0.6s 0.2s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);">
            <div class="relative w-10 h-10 md:w-12 md:h-12">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 md:w-10 md:h-10 text-primary absolute top-0 left-0"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 md:w-10 md:h-10 text-accent absolute bottom-0 right-0"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 016 0v8.25a3 3 0 01-3 3z"></path></svg>
            </div>
            <span class="font-bold" data-locale="appName"></span>
        </div>
        <p class="mt-3 md:mt-4 text-lg md:text-xl text-text-secondary" data-locale="tagline" style="opacity:0; transform: translateY(20px); animation: splash-fade-up 0.6s 0.5s forwards;"></p>
        <!-- Loading indicator for mobile -->
        <div class="mt-6 w-16 h-1 bg-gray-200 rounded-full overflow-hidden">
            <div class="h-full bg-primary rounded-full" style="width: 0%; animation: loading 1.5s ease-in-out forwards;"></div>
        </div>
    </div>
   
    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="opacity-0 transition-opacity duration-500 flex flex-col min-h-screen">
        <!-- Top Navbar (for Desktop) -->
        <nav class="sticky top-0 z-40 bg-white/30 dark:bg-black/30 backdrop-blur-lg shadow-sm hidden md:block">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <button class="flex items-center gap-2" data-nav="home">
                        <div class="relative w-8 h-8">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary absolute top-0 left-0"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-accent absolute bottom-0 right-0"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 016 0v8.25a3 3 0 01-3 3z"></path></svg>
                        </div>
                        <span class="font-bold text-lg" data-locale="appName"></span>
                    </button>
                    <div class="flex items-center gap-x-6">
                        <button class="nav-link font-semibold" data-nav="home" data-locale="nav.home"></button>
                        <button class="nav-link font-semibold" data-nav="notes" data-locale="nav.notes"></button>
                        <button class="nav-link font-semibold" data-nav="settings" data-locale="nav.settings"></button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto p-4 md:p-8 flex-grow pb-24 md:pb-8">
            <!-- Pages will be injected here by JS -->
        </main>

        <!-- Bottom Navbar (for Mobile) -->
        <nav class="fixed bottom-0 left-0 right-0 z-40 bg-white/50 dark:bg-black/50 backdrop-blur-lg shadow-[0_-2px_5px_rgba(0,0,0,0.1)] md:hidden">
            <div class="flex justify-around h-16">
                 <button class="nav-link flex flex-col items-center justify-center w-full" data-nav="home">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="text-xs" data-locale="nav.home"></span>
                </button>
                <button class="nav-link flex flex-col items-center justify-center w-full" data-nav="notes">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span class="text-xs" data-locale="nav.notes"></span>
                </button>
                <button class="nav-link flex flex-col items-center justify-center w-full" data-nav="settings">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="text-xs" data-locale="nav.settings"></span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 md:bottom-5 left-5 right-5 md:left-auto md:right-auto mx-auto md:mx-0 max-w-sm bg-primary text-white py-3 px-5 rounded-lg shadow-lg z-50 flex items-center gap-3 opacity-0 translate-y-10 transition-all duration-300">
        <svg id="toast-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"></svg>
        <span id="toast-message" class="font-medium"></span>
    </div>

    <!-- Templates -->
    <template id="note-card-template">
        <div class="glassmorphism-card p-4 rounded-xl flex flex-col h-full note-card transition-all duration-300">
            <div class="flex-grow">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-lg text-primary mb-2 break-words note-title"></h3>
                    <button class="text-accent hover:scale-125 transition-transform favorite-btn btn-animated">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"></svg>
                    </button>
                </div>
                <p class="text-text-secondary text-sm break-words whitespace-pre-wrap note-content"></p>
            </div>
            <div class="flex items-center gap-2 mt-4 pt-2 border-t border-white/10 self-end">
                <button class="p-2 text-text-secondary hover:text-primary transition-colors edit-btn btn-animated">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                </button>
                <button class="p-2 text-text-secondary hover:text-red-500 transition-colors delete-btn btn-animated">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                </button>
            </div>
        </div>
    </template>
    
    <script>
    // --- ADVANCED & MODULAR JAVASCRIPT ---
    ((window, document) => {
        'use strict';

        // --- 1. STATE MANAGEMENT ---
        const state = {
            currentPage: 'home',
            theme: 'light',
            lang: 'ur',
            fontSize: 'medium',
            notes: [],
            isListening: false,
            recognition: null,
            currentToast: null,
            locales: {
                en: {
                    appName: "Urdu Notes & Voice App", tagline: "Write, Listen, and Save Notes",
                    nav: { home: "Home", notes: "Notes", settings: "Settings" },
                    home: { title: "Welcome to", subtitle: "Your personal space for thoughts and reminders, designed with care for Urdu speakers.", cta: "Get Started" },
                    notes: { title: "My Notes", placeholderTitle: "Note Title", placeholderContent: "Start typing or use the microphone to dictate...", save: "Save", update: "Update", cancel: "Cancel", micTitle: "Start Listening", micActiveTitle: "Listening...", deleteConfirm: "Are you sure you want to delete this note?", noNotes: "No notes yet. Create your first one!", favorited: "Favorited", favorite: "Favorite" },
                    settings: { title: "Settings", theme: "Theme", light: "Light", dark: "Dark", highContrast: "High Contrast", language: "Language", fontSize: "Font Size", small: "Small", medium: "Medium", large: "Large" },
                    toast: { noteSaved: "Note saved!", noteUpdated: "Note updated!", noteDeleted: "Note deleted.", toggledFavorite: "Toggled favorite status.", error: "An error occurred.", micPermission: "Microphone access denied. Please allow it in browser settings.", noSpeech: "No speech was detected. Please try again.", httpsWarning: "Voice feature may not work on non-HTTPS sites." }
                },
                ur: {
                    appName: "نوٹ لکھیں اور سنیں", tagline: "نوٹ لکھیں، سنیں، اور محفوظ کریں",
                    nav: { home: "صفحہ اول", notes: "نوٹس", settings: "ترتیبات", about: "ہمارے بارے میں" },
                    home: { title: "خوش آمدید", subtitle: "آپ کے خیالات اور یاد دہانیوں کے لیے آپ کی ذاتی جگہ، جو اردو بولنے والوں کے لیے خاص طور پر ڈیزائن کی گئی ہے۔", cta: "شروع کریں" },
                    notes: { title: "میرے نوٹس", placeholderTitle: "نوٹ کا عنوان", placeholderContent: "لکھنا شروع کریں یا بول کر لکھوانے کے لیے مائیکروفون استعمال کریں...", save: "محفوظ کریں", update: "اپ ڈیٹ کریں", cancel: "منسوخ", micTitle: "سننا شروع کریں", micActiveTitle: "سن رہا ہے...", deleteConfirm: "کیا آپ واقعی اس نوٹ کو حذف کرنا چاہتے ہیں؟", noNotes: "ابھی تک کوئی نوٹ نہیں ہے۔ اپنا پہلا نوٹ بنائیں!", favorited: "پسندیدہ", favorite: "پسندیدہ بنائیں" },
                    settings: { title: "ترتیبات", theme: "تھیم", light: "لائٹ", dark: "ڈارک", highContrast: "ہائی کنٹراسٹ", language: "زبان", fontSize: "فونٹ سائز", small: "چھوٹا", medium: "درمیانہ", large: "بڑا" },
                    toast: { noteSaved: "نوٹ کامیابی سے محفوظ ہو گیا!", noteUpdated: "نوٹ اپ ڈیٹ ہو گیا!", noteDeleted: "نوٹ حذف کر دیا گیا۔", toggledFavorite: "پسندیدہ حیثیت تبدیل کر دی گئی۔", error: "ایک خرابی پیش آگئی۔", micPermission: "مائیکروفون تک رسائی مسترد کر دی گئی۔ براہ کرم براؤزر کی ترتیبات میں اس کی اجازت دیں۔", noSpeech: "کوئی آواز نہیں ملی۔ براہ کرم دوبارہ کوشش کریں۔", httpsWarning: "وائس فیچر غیر محفوظ (HTTP) سائٹس پر کام نہیں کر سکتا۔" }
                }
            }
        };

        // --- 2. DOM SELECTOR UTILITY ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- 3. UI MODULE ---
        const UI = {
            init() {
                this.mainContent = $('main');
                this.toast = { el: $('#toast'), icon: $('#toast-icon'), msg: $('#toast-message') };
                this.renderPage();
                this.updateTheme();
                this.updateLanguage();
            },
            renderPage() {
                const pageId = state.currentPage;
                let content = '';
                if (pageId === 'home') content = this.getHomePageHTML();
                if (pageId === 'notes') content = this.getNotesPageHTML();
                if (pageId === 'settings') content = this.getSettingsPageHTML();
                if (pageId === 'about') content = this.getAboutPageHTML();
                // FIX: Added the ID to the wrapper div to ensure elements can be found.
                this.mainContent.innerHTML = `<div id="page-${pageId}" class="page active">${content}</div>`;
                this.updateLanguage();
                if (pageId === 'notes') Notes.postRenderSetup();
                if (pageId === 'settings') Settings.postRenderSetup();
            },
            updateTheme() {
                document.documentElement.className = state.theme;
            },
            updateLanguage() {
                const t = state.locales[state.lang];
                document.documentElement.lang = state.lang;
                document.documentElement.dir = state.lang === 'ur' ? 'rtl' : 'ltr';
                document.body.className = `font-${state.lang === 'ur' ? 'urdu' : 'english'} font-size-${state.fontSize} min-h-screen`;
                $$('[data-locale]').forEach(el => {
                    const key = el.getAttribute('data-locale');
                    const value = key.split('.').reduce((o, i) => (o ? o[i] : undefined), t);
                    if (value) el.textContent = value;
                });
                this.updateToastPosition();
            },
            updateFontSize() {
                this.updateLanguage(); // This re-applies all body classes
            },
            updateNav() {
                $$('.nav-link').forEach(link => {
                    const isActive = link.dataset.nav === state.currentPage;
                    link.classList.toggle('text-primary', isActive);
                    link.classList.toggle('text-text-secondary', !isActive);
                    link.classList.toggle('hover:text-primary', !isActive);
                });
            },
            showToast(message, type = 'success') {
                if (state.currentToast) clearTimeout(state.currentToast);
                this.toast.msg.textContent = message;
                this.toast.el.classList.remove('bg-primary', 'bg-red-500');
                this.toast.el.classList.add(type === 'success' ? 'bg-primary' : 'bg-red-500');
                this.toast.icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="${type === 'success' ? 'M4.5 12.75l6 6 9-13.5' : 'M6 18L18 6M6 6l12 12'}"></path>`;
                this.toast.el.classList.remove('opacity-0', 'translate-y-10');
                state.currentToast = setTimeout(() => {
                    this.toast.el.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            },
            updateToastPosition() {
                this.toast.el.classList.remove('md:left-auto', 'md:right-auto');
                if (state.lang === 'ur') {
                    this.toast.el.classList.add('md:right-5');
                } else {
                    this.toast.el.classList.add('md:left-5');
                }
            },
            getHomePageHTML: () => `
                <div class="flex flex-col items-center justify-center text-center h-full min-h-[80vh] py-4 md:py-16">
                    <div class="flex flex-col items-center">
                        <h1 class="text-4xl md:text-6xl font-bold mb-2" data-locale="home.title"></h1>
                        <h2 class="text-5xl md:text-7xl font-bold text-primary mb-6" data-locale="appName"></h2>
                    </div>
                    <p class="max-w-2xl text-lg md:text-xl text-text-secondary mb-10" data-locale="home.subtitle"></p>
                    <button data-nav="notes" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 text-lg btn-animated" data-locale="home.cta"></button>
                </div>`,
            getNotesPageHTML: () => `
                <div class="flex flex-col items-center justify-center min-h-[80vh]">
                    <h1 class="text-3xl font-bold text-primary mb-6"  data-locale="notes.title"></h1>
                    <div class="glassmorphism-card p-4 md:p-6 rounded-xl mb-8 w-full max-w-4xl">
                        <form id="note-form">
                            <input type="hidden" id="note-id">
                            <input type="text" id="note-title" class="w-full bg-transparent border-b-2 border-primary/50 focus:border-primary p-2 text-lg font-bold outline-none mb-4" required data-locale-placeholder="notes.placeholderTitle">
                            <div class="relative">
                                <textarea id="note-content" class="w-full bg-transparent p-2 outline-none resize-none min-h-[100px]" rows="4" required data-locale-placeholder="notes.placeholderContent"></textarea>
                                <button type="button" id="mic-button" class="absolute bottom-2 p-2 rounded-full transition-colors bg-accent text-white btn-animated">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 016 0v8.25a3 3 0 01-3 3z"></path></svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-4 mt-4">
                                <button type="submit" id="save-note-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-6 rounded-lg transition-all duration-300 btn-animated" style="display: block;" data-locale="notes.save"></button>
                                <button type="button" id="cancel-edit-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-all hidden btn-animated" data-locale="notes.cancel"></button>
                            </div>
                        </form>
                    </div>
                    <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full"></div>
                    <div id="no-notes-message" class="text-center p-10 text-text-secondary hidden"></div>
                </div>`,
            getSettingsPageHTML: () => `
                <div class="flex flex-col items-center justify-center min-h-[80vh]">
                    <h1 class="text-3xl font-bold text-primary mb-6" data-locale="settings.title"></h1>
                    <div class="glassmorphism-card rounded-xl overflow-hidden max-w-4xl w-full">
                        <div class="p-4 border-b border-primary/10">
                            <h3 class="text-lg font-semibold mb-3" data-locale="settings.theme"></h3>
                            <div id="theme-options" class="flex flex-wrap gap-3"></div>
                        </div>
                        <div class="p-4 border-b border-primary/10">
                            <h3 class="text-lg font-semibold mb-3" data-locale="settings.language"></h3>
                            <div id="lang-options" class="flex flex-wrap gap-3"></div>
                        </div>
                        <div class="p-4">
                            <h3 class="text-lg font-semibold mb-3" data-locale="settings.fontSize"></h3>
                            <div id="font-size-options" class="flex flex-wrap gap-3"></div>
                        </div>
                    </div>
                </div>`,
            getAboutPageHTML: () => `
                <div class="flex flex-col items-center justify-center min-h-[80vh]">
                    <h1 class="text-3xl font-bold text-primary mb-6" data-locale="about.title"></h1>
                    <div class="glassmorphism-card rounded-xl overflow-hidden max-w-4xl w-full p-6">
                        <p class="text-lg mb-8" data-locale="about.description"></p>
                        
                        <h2 class="text-2xl font-bold text-primary mb-4" data-locale="about.features"></h2>
                        <ul class="list-disc list-inside space-y-2 mb-8">
                            <li data-locale="about.feature1"></li>
                            <li data-locale="about.feature2"></li>
                            <li data-locale="about.feature3"></li>
                            <li data-locale="about.feature4"></li>
                            <li data-locale="about.feature5"></li>
                        </ul>
                        
                        <div class="text-center text-text-secondary mt-8" data-locale="about.credits"></div>
                    </div>
                </div>`,
        };

        // --- 4. NOTES MODULE ---
        const Notes = {
            postRenderSetup() {
                this.form = $('#note-form');
                this.id = $('#note-id');
                this.title = $('#note-title');
                this.content = $('#note-content');
                this.saveBtn = $('#save-note-btn');
                this.cancelBtn = $('#cancel-edit-btn');
                this.grid = $('#notes-grid');
                this.noNotesMsg = $('#no-notes-message');
                this.micBtn = $('#mic-button');

                this.form.addEventListener('submit', this.handleSubmit.bind(this));
                this.cancelBtn.addEventListener('click', this.resetForm.bind(this));
                this.grid.addEventListener('click', this.handleGridClick.bind(this));
                this.content.addEventListener('input', this.autoResizeTextarea.bind(this));
                this.micBtn.addEventListener('click', Voice.toggle.bind(Voice));
                
                this.render();
                this.updatePlaceholders();
            },
            updatePlaceholders() {
                const t = state.locales[state.lang];
                this.title.placeholder = t.notes.placeholderTitle;
                this.content.placeholder = t.notes.placeholderContent;
            },
            render() {
                this.grid.innerHTML = '';
                const t = state.locales[state.lang];
                if (state.notes.length === 0) {
                    this.noNotesMsg.classList.remove('hidden');
                    this.noNotesMsg.textContent = t.notes.noNotes;
                } else {
                    this.noNotesMsg.classList.add('hidden');
                    const sorted = [...state.notes].sort((a, b) => (b.isFavorite - a.isFavorite) || (new Date(b.updatedAt) - new Date(a.updatedAt)));
                    sorted.forEach(note => this.grid.appendChild(this.createCard(note)));
                }
            },
            createCard(note) {
                const template = $('#note-card-template');
                const card = template.content.cloneNode(true);
                const cardEl = card.querySelector('.note-card');
                cardEl.dataset.id = note.id;
                cardEl.querySelector('.note-title').textContent = note.title;
                cardEl.querySelector('.note-content').textContent = note.content;
                
                const favBtn = cardEl.querySelector('.favorite-btn');
                const favIcon = favBtn.querySelector('svg');
                favBtn.title = note.isFavorite ? state.locales[state.lang].notes.favorited : state.locales[state.lang].notes.favorite;
                favIcon.innerHTML = note.isFavorite 
                    ? '<path fill="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />'
                    : '<path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />';
                
                // Add play button to note card
                const actionsDiv = cardEl.querySelector('.flex.items-center.gap-2');
                const playBtn = document.createElement('button');
                playBtn.className = 'p-2 text-text-secondary hover:text-accent transition-colors play-btn btn-animated';
                playBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" /></svg>';
                actionsDiv.insertBefore(playBtn, actionsDiv.firstChild);
                
                return cardEl;
            },
            saveToStorage() {
                localStorage.setItem('urduNotes', JSON.stringify(state.notes));
            },
            loadFromStorage() {
                state.notes = JSON.parse(localStorage.getItem('urduNotes') || '[]');
            },
            resetForm() {
                this.form.reset();
                this.id.value = '';
                this.cancelBtn.classList.add('hidden');
                UI.updateLanguage(); // To reset button text
            },
            handleSubmit(e) {
                e.preventDefault();
                const id = this.id.value;
                const title = this.title.value.trim();
                const content = this.content.value.trim();
                const t = state.locales[state.lang];
                if (!title || !content) return;
                if (id) {
                    const note = state.notes.find(n => n.id === id);
                    if (note) {
                        note.title = title;
                        note.content = content;
                        note.updatedAt = new Date().toISOString();
                        UI.showToast(t.toast.noteUpdated);
                    }
                } else {
                    state.notes.push({ id: `note_${Date.now()}`, title, content, isFavorite: false, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                    UI.showToast(t.toast.noteSaved);
                }
                this.saveToStorage();
                this.render();
                this.resetForm();
            },
            handleGridClick(e) {
                const btn = e.target.closest('button');
                if (!btn) return;
                const card = btn.closest('.note-card');
                const noteId = card.dataset.id;
                const note = state.notes.find(n => n.id === noteId);
                const t = state.locales[state.lang];
                if (btn.classList.contains('edit-btn')) {
                    this.id.value = note.id;
                    this.title.value = note.title;
                    this.content.value = note.content;
                    this.cancelBtn.classList.remove('hidden');
                    UI.updateLanguage();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (btn.classList.contains('delete-btn')) {
                    if (confirm(t.notes.deleteConfirm)) {
                        state.notes = state.notes.filter(n => n.id !== noteId);
                        this.saveToStorage();
                        this.render();
                        UI.showToast(t.toast.noteDeleted);
                    }
                } else if (btn.classList.contains('favorite-btn')) {
                    note.isFavorite = !note.isFavorite;
                    this.saveToStorage();
                    this.render();
                    UI.showToast(t.toast.toggledFavorite);
                } else if (btn.classList.contains('play-btn')) {
                    // Play the note content using text-to-speech
                    Voice.playText(note.content);
                }
            },
            autoResizeTextarea() {
                this.content.style.height = 'auto';
                this.content.style.height = `${this.content.scrollHeight}px`;
            }
        };

        // --- 5. VOICE MODULE ---
        const Voice = {
            init() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.warn("Speech Recognition not supported.");
                    return;
                }
                
                state.recognition = new SpeechRecognition();
                state.recognition.continuous = true;
                state.recognition.interimResults = true;
                state.recognition.onstart = () => this.handleStateChange(true);
                state.recognition.onend = () => this.handleStateChange(false);
                state.recognition.onerror = this.handleError.bind(this);
                state.recognition.onresult = this.handleResult.bind(this);
                
                // Initialize speech synthesis
                this.synth = window.speechSynthesis;
            },
            toggle() {
                if (!state.recognition) return;
                if (state.isListening) {
                    state.recognition.stop();
                } else {
                    try {
                        state.recognition.lang = state.lang === 'ur' ? 'ur-PK' : 'en-US';
                        state.recognition.start();
                    } catch(e) {
                        console.error("Could not start recognition:", e);
                        UI.showToast(state.locales[state.lang].toast.error, 'error');
                    }
                }
            },
            handleStateChange(isListening) {
                state.isListening = isListening;
                const micBtn = $('#mic-button');
                if (micBtn) {
                    micBtn.classList.toggle('bg-red-500', isListening);
                    micBtn.classList.toggle('animate-pulse', isListening);
                    micBtn.classList.toggle('bg-accent', !isListening);
                }
                UI.updateLanguage();
            },
            handleError(event) {
                const t = state.locales[state.lang];
                console.error('Speech recognition error:', event.error);
                let msg = t.toast.error;
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') msg = t.toast.micPermission;
                else if (event.error === 'no-speech') msg = t.toast.noSpeech;
                UI.showToast(msg, 'error');
            },
            handleResult(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                }
                const contentEl = $('#note-content');
                if (contentEl) {
                    contentEl.value += (contentEl.value ? ' ' : '') + finalTranscript;
                    Notes.autoResizeTextarea();
                }
            },
            // Yeh function note ko awaz mein badal kar sunata hai
            playText(text) {
                if (!window.speechSynthesis) {
                    console.warn("Speech Synthesis not supported.");
                    UI.showToast(state.locales[state.lang].toast.error, 'error');
                    return;
                }
                
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Create a new speech utterance
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Set the language based on current app language
                utterance.lang = state.lang === 'ur' ? 'ur-PK' : 'en-US';
                
                // Get available voices
                const voices = window.speechSynthesis.getVoices();
                
                // Try to find a voice for the current language
                let voice = null;
                if (state.lang === 'ur') {
                    // Try to find Urdu voice
                    voice = voices.find(v => v.lang.includes('ur') || v.lang.includes('hi'));
                } else {
                    // Find English voice
                    voice = voices.find(v => v.lang.includes('en'));
                }
                
                // Set the voice if found
                if (voice) utterance.voice = voice;
                
                // Adjust speech rate slightly slower for better comprehension
                utterance.rate = 0.9;
                
                // Play the speech
                window.speechSynthesis.speak(utterance);
            }
        };

        // --- 6. SETTINGS MODULE ---
        const Settings = {
            load() {
                state.theme = localStorage.getItem('theme') || 'light';
                state.lang = localStorage.getItem('lang') || 'ur';
                state.fontSize = localStorage.getItem('fontSize') || 'medium';
            },
            postRenderSetup() {
                this.themeOptions = $('#theme-options');
                this.langOptions = $('#lang-options');
                this.fontSizeOptions = $('#font-size-options');
                this.renderOptions();
                // FIX: Added a null check to prevent error if the element doesn't exist.
                const settingsPage = $('#page-settings');
                if (settingsPage) {
                    settingsPage.addEventListener('change', this.handleChange.bind(this));
                }
            },
            renderOptions() {
                const t = state.locales[state.lang];
                const createRadio = (name, val, lbl, checked) => `<label class="flex items-center gap-2 cursor-pointer p-2 rounded-md hover:bg-primary/10 transition-colors"><input type="radio" name="${name}" value="${val}" ${checked ? 'checked' : ''} class="hidden"><span class="w-5 h-5 rounded-full border-2 ${checked ? 'border-primary bg-primary' : 'border-text-secondary'} flex items-center justify-center">${checked ? '<span class="w-2 h-2 rounded-full bg-white"></span>' : ''}</span><span>${lbl}</span></label>`;
                if (this.themeOptions) this.themeOptions.innerHTML = [{ v: 'light', l: t.settings.light }, { v: 'dark', l: t.settings.dark }, { v: 'high-contrast', l: t.settings.highContrast }].map(o => createRadio('theme', o.v, o.l, state.theme === o.v)).join('');
                if (this.langOptions) this.langOptions.innerHTML = [{ v: 'en', l: 'English' }, { v: 'ur', l: 'اردو' }].map(o => createRadio('lang', o.v, o.l, state.lang === o.v)).join('');
                if (this.fontSizeOptions) this.fontSizeOptions.innerHTML = [{ v: 'small', l: t.settings.small }, { v: 'medium', l: t.settings.medium }, { v: 'large', l: t.settings.large }].map(o => createRadio('fontSize', o.v, o.l, state.fontSize === o.v)).join('');
            },
            handleChange(e) {
                const { name, value } = e.target;
                if (name === 'theme') {
                    state.theme = value;
                    localStorage.setItem('theme', value);
                    UI.updateTheme();
                } else if (name === 'lang') {
                    state.lang = value;
                    localStorage.setItem('lang', value);
                    UI.updateLanguage();
                } else if (name === 'fontSize') {
                    state.fontSize = value;
                    localStorage.setItem('fontSize', value);
                    UI.updateFontSize();
                }
                this.renderOptions();
            }
        };

        // --- 7. APP INITIALIZATION ---
        const App = {
            init() {
                document.addEventListener('click', (e) => {
                    const navBtn = e.target.closest('[data-nav]');
                    if (navBtn) {
                        state.currentPage = navBtn.dataset.nav;
                        UI.renderPage();
                        UI.updateNav();
                    }
                });
                Settings.load();
                Notes.loadFromStorage();
                UI.init();
                Voice.init();
                UI.updateNav();
                
                // HTTP warning ko hata diya hai
                // if (window.location.protocol !== 'https:') {
                //     UI.showToast(state.locales[state.lang].toast.httpsWarning, 'error');
                // }
                
                // Splash screen ko 1.5 seconds ke baad hide karta hai (mobile ke liye optimize kiya hai)
                setTimeout(() => {
                    $('#splash-screen').style.opacity = '0';
                    $('#app-wrapper').style.opacity = '1';
                    setTimeout(() => $('#splash-screen').style.display = 'none', 700);
                }, 1500);
            }
        };

        App.init();

    })(window, document);
    </script>
    
    <!-- Loading animation for splash screen -->
    <style>
    @keyframes loading {
        0% { width: 0%; }
        50% { width: 70%; }
        100% { width: 100%; }
    }
    </style>
</body>
</html>
